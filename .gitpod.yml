# .gitpod.yml
tasks:
  - name: Docker Setup
    init: |
      set -ex # Ativa modo debug e sai ao primeiro erro
      
      # 1. Criar estrutura de diretÃ³rios
      mkdir -p .metagpt metagpt/workspace
      echo "ğŸ“‚ Estrutura de diretÃ³rios criada"
      
      # 2. Baixar imagem Docker com feedback visual
      echo "â¬‡ï¸ Baixando imagem MetaGPT (isso pode levar alguns minutos)..."
      docker pull --progress=plain metagpt/metagpt:latest 2>&1 | tee /tmp/docker-pull.log
      
      # 3. Verificar download da imagem
      if ! docker image inspect metagpt/metagpt:latest &>/dev/null; then
        echo "âŒ Falha no download da imagem Docker!"
        exit 1
      fi
      
      # 4. ConfiguraÃ§Ã£o segura da API Key
      echo "ğŸ”‘ Configurando chave API..."
      cat << EOF > .metagpt/config2.yaml
      llm:
        api_type: "openai"
        api_key: "${HUGGINGFACE_QWQ32B:-CHAVE_NAO_CONFIGURADA}"
        model: "Qwen/QwQ-32B"
        base_url: "https://router.huggingface.co/hf-inference/models/Qwen/QwQ-32B/v1"
      EOF
      
      # 5. Validar substituiÃ§Ã£o da chave
      if grep -q "CHAVE_NAO_CONFIGURADA" .metagpt/config2.yaml; then
        echo "âŒ ERRO: VariÃ¡vel HUGGINGFACE_QWQ32B nÃ£o encontrada!"
        echo "Configure em: https://gitpod.io/user/variables"
        exit 1
      fi
      
      # 6. Sinalizar conclusÃ£o
      gp sync-done docker_ready
      echo "âœ… ConfiguraÃ§Ã£o Docker concluÃ­da!"

  - name: MetaGPT Runner
    command: |
      # Esperar conclusÃ£o do setup
      echo "â³ Aguardando preparaÃ§Ã£o do ambiente..."
      gp sync-await docker_ready
      
      # Configurar aliases
      echo -e "\nğŸ“¦ Configurando comandos rÃ¡pidos..."
      echo "alias metagpt='docker run -it --rm --privileged \
        -v $(pwd)/.metagpt/config2.yaml:/app/metagpt/config/config2.yaml \
        -v $(pwd)/metagpt/workspace:/app/metagpt/workspace \
        metagpt/metagpt:latest metagpt'" >> ~/.bashrc
      
      source ~/.bashrc
      
      # Mensagem final
      echo -e "\n\033[32mğŸš€ Ambiente Pronto!\033[0m"
      echo -e "Teste com: \033[36mmetagpt 'Crie um script Python simples'\033[0m"
      echo -e "Arquivos gerados em: \033[33mmetagpt/workspace/\033[0m"

ports:
  - port: 3000
    onOpen: open-preview
    visibility: public